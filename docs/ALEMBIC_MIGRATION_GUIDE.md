# Alembic Migration Guide

## Overview

We've successfully migrated from raw SQL migrations to Alembic for database schema management. This provides better version control, rollback capabilities, and integration with SQLAlchemy/SQLModel.

## Migration Files Created

### 1. Workflow State Management Migration
- **File**: `alembic/versions/20250916_1055-83e20b278cac_add_workflow_state_management.py`
- **Revision ID**: `83e20b278cac`
- **Features Added**:
  - `workflow_transitions` table for state change audit trail
  - `workflow_metrics` table for performance tracking
  - `workflow_events` table for event sourcing
  - `workflow_deadletter` table for failed items
  - New columns in `processing_queue`: `workflow_state`, `workflow_version`, `locked_by`, `locked_at`
  - Functions: `transition_workflow_state()`, `acquire_workflow_lock()`, `release_workflow_lock()`
  - Views: `vw_workflow_status`, `vw_workflow_performance`

### 2. Quota Management Migration
- **File**: `alembic/versions/20250916_1057-3abc3b73b4a9_add_quota_management.py`
- **Revision ID**: `3abc3b73b4a9`
- **Features Added**:
  - `quota_usage_log` table for tracking API usage
  - `quota_limits` table for configurable limits
  - New columns in `processing_queue`: `partial_results`, `quota_exceeded_count`, `last_quota_check`
  - Views: `vw_quota_usage_current`, `vw_quota_exceeded_workflows`
  - Functions: `get_quota_usage_summary()`, `estimate_quota_reset_time()`
  - Trigger: `trg_quota_exceeded_count` for automatic tracking

## Usage

### Running Migrations

```bash
# Check current migration status
make db-current

# View migration history
make db-history

# Run all pending migrations
make db-migrate

# Create a new migration
make db-revision
# Enter migration message when prompted
```

### Direct Alembic Commands

```bash
# Activate virtual environment first
source venv/bin/activate

# Upgrade to latest
alembic upgrade head

# Downgrade one revision
alembic downgrade -1

# Create new migration
alembic revision -m "Your migration message"

# Create auto-generated migration
alembic revision --autogenerate -m "Your message"
```

## Configuration

### alembic.ini
- Located at project root
- Configured to read database URL from environment
- File naming pattern includes timestamp for better tracking
- Black formatter disabled (can be re-enabled by uncommenting)

### alembic/env.py
- Handles async database connections
- Escapes special characters in database URLs
- Imports SQLModel metadata for autogeneration
- Supports both online and offline migrations

## Best Practices

1. **Always Review Autogenerated Migrations**
   - Alembic may miss some changes or include unnecessary ones
   - Check column types, indexes, and constraints

2. **Test Migrations Locally**
   - Run `alembic upgrade head` on a test database
   - Verify with `alembic current`
   - Test downgrade with `alembic downgrade -1`

3. **Write Descriptive Messages**
   - Use clear, descriptive migration messages
   - Include what tables/columns are affected

4. **Handle Permissions Gracefully**
   ```sql
   DO $$ BEGIN 
       GRANT SELECT ON table_name TO user; 
   EXCEPTION WHEN undefined_object THEN NULL; 
   END $$;
   ```

5. **Split Complex Migrations**
   - Keep migrations focused on one feature
   - Easier to debug and rollback if needed

## Troubleshooting

### Common Issues

1. **Import Errors**
   - Ensure virtual environment is activated
   - Install requirements: `pip install -r requirements/base.txt`

2. **Database URL Special Characters**
   - The env.py file handles escaping automatically
   - URLs with % characters are escaped to %%

3. **Missing Extensions**
   - PostgreSQL extensions are created in `setup_database.py`
   - Run `make db-setup` if extensions are missing

4. **Permission Errors**
   - Migrations wrap GRANT statements in exception handlers
   - Won't fail if users don't exist

## Migration Workflow

1. **Development**
   ```bash
   # Create feature branch
   git checkout -b feature/new-schema
   
   # Make model changes in app/models/
   
   # Generate migration
   alembic revision --autogenerate -m "Add new feature tables"
   
   # Review and edit migration file
   
   # Test migration
   alembic upgrade head
   alembic downgrade -1
   alembic upgrade head
   ```

2. **Deployment**
   ```bash
   # Pull latest code
   git pull origin main
   
   # Install dependencies
   make install
   
   # Run migrations
   make db-migrate
   ```

## Related Documentation

- [Database Improvements](./DATABASE_IMPROVEMENTS.md)
- [Workflow Improvements](./WORKFLOW_IMPROVEMENTS.md)
- [Dependency Management](./DEPENDENCY_IMPROVEMENTS.md)

## Next Steps

1. Remove old SQL migration files from `migrations/` directory
2. Set up CI/CD to run migrations automatically
3. Add migration testing to test suite
4. Configure staging environment migrations
